<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Set Up Fitting • ramp.work</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Set Up Fitting">
<meta property="og:description" content="ramp.work">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ramp.work</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Scaling.html">Scaling</a>
    </li>
    <li>
      <a href="../articles/Seasonality.html">Seasonality</a>
    </li>
    <li>
      <a href="../articles/Trend.html">Trends</a>
    </li>
    <li>
      <a href="../articles/History.html">History</a>
    </li>
    <li>
      <a href="../articles/Forecast.html">Forecast</a>
    </li>
    <li>
      <a href="../articles/Effect_Sizes.html">Effect Sizes</a>
    </li>
    <li>
      <a href="../articles/Hindcasting.html">Hindcasting</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dd-harp/ramp.xds/" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Set Up Fitting</h1>
            <h3 data-toc-skip class="subtitle">Fitting a Dynamical
System to a PfPR Time Series</h3>
            
            <h4 data-toc-skip class="date">July 21, 2025</h4>
      
      
      <div class="hidden name"><code>Fitting.Rmd</code></div>

    </div>

    
    
<hr>
<div class="section level2">
<h2 id="how-to">How To<a class="anchor" aria-label="anchor" href="#how-to"></a>
</h2>
<p>To set up fitting, we need <code>ramp.xds</code> and
<code>ramp.work</code></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dd-harp.github.io/ramp.xds/">ramp.xds</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ramp.work</span><span class="op">)</span></span></code></pre></div>
<p>Assuming we have set up a <strong><code>ramp.xds</code></strong>
model object, called <code>model.</code> For differential equation
models, we run <code>xde_scaling</code> to set up
<code>model$outputs$eirpr.</code> This makes it possible to make some
good initial guesses for the parameter we will want to fit:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/xde_scaling.html">xde_scaling</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> </span></code></pre></div>
<p>Now, we set up fitting, and we pass the <code>pfpr</code> time series
and the paired <code>jdates</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">setup_fitting_model</span><span class="op">(</span><span class="va">model</span>, <span class="va">pfpr</span>, <span class="va">jdates</span><span class="op">)</span></span></code></pre></div>
<p>At this point, we’re ready to fit the model:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pr2history.html">pr2history</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">pfpr</span>, <span class="va">jdates</span><span class="op">)</span></span></code></pre></div>
<p>In the following, we present a longer introduction, a fully worked
example, and a discussion of the implementation (for <code>dev</code>
nerds).</p>
<hr>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><strong><code>ramp.work</code></strong> was developed with the goal
of fitting a malaria – a dynamical system of malaria epidemiology,
transmission dynamics, and control – to a <em>Pf</em>PR time series.
What are we fitting?</p>
<p>In all these models, we assume that malaria epidemiology is being
<em>forced</em> by something. When we do the analytics, we want to have
some flexibility in choosing what is forcing malaria epidemiology. Given
a <em>Pf</em>PR time series, we might want to:</p>
<ul>
<li><p>estimate <strong>exposure,</strong> defined by the <em>Pf</em>EIR
(<code>eir</code>);</p></li>
<li><p>fit a model with transmission forced by mosquito
<strong>emergence</strong> (<code>Lambda</code>);</p></li>
<li><p>fit a model with mosquito ecology forced by changes in mosquito
carrying capacity.</p></li>
<li><p>estimate the <strong>effect sizes</strong> of vector control,
contigent on a <strong>counterfactual baseline</strong></p></li>
</ul>
<p>To do the fitting in a sensible way, we need to have some ways of
setting and modifying parameters describing <em>interannual
variability.</em> Since the models are dynamical systems, we need the
algorithms to handle some issues that do not affect other kinds of
time-series analysis. In particular, the dynamical systems approach
forces us to confront the historical context for malaria – what happened
before? We can identify these challenges:</p>
<ul>
<li><p><strong>Hindcast</strong> – During model fitting, the predicted
<em>Pf</em>PR will be sensitive to the <em>initial conditions</em> that
are set when we solve the differential equations. We must thus consider
the handling of these initial conditions as a part of the fitting
process, and we will need to be attentive to the way the fitting handles
a <em>burn-in</em> period to set the initial conditions.</p></li>
<li>
<p>The forcing function is decomposed into three parts, a mean
(<span class="math inline">\(m\)</span>), a seasonal pattern <span class="math inline">\(S(t)\)</span>, and a trend, <span class="math inline">\(T(t)\)</span>. The functions we use are
multiplicative, so <span class="math inline">\(F(t) = m S(t)
T(t)\)</span>.</p>
<ul>
<li><p><strong>Average</strong> – we fit the mean value</p></li>
<li><p><strong>Seasonal Pattern</strong> – We assume that malaria
transmission is seasonal to some extend, so we fit the <em>phase,</em>
<em>amplitude,</em> and <em>shape</em> of seasonal forcing. We call it a
seasonal <em>pattern</em> because we constrain the values of <span class="math inline">\(S(t)\)</span> so that it does not modify the
arithmetic mean of <span class="math inline">\(F(t)\)</span>.</p></li>
<li><p><strong>Trend</strong> – We set up a <strong>spline</strong>
using a set of interpolation points: the <span class="math inline">\(t\)</span> values of the interpolation points are,
by default, set to every year. Since <span class="math inline">\(F(t)\)</span> is multiplicative, the average value
of <span class="math inline">\(T(t)\)</span> over the year should be
close to one.</p></li>
</ul>
</li>
<li><p><strong>Forecast</strong> – To set up models for scenario
planning, we need the ability to do short-term forecasting. We can also
use the <em>forecasting</em> infrastructure to ensure that there is some
consistency about fitting at the end of the time series.</p></li>
</ul>
<p>We handle this in two steps:</p>
<ul>
<li>
<p><strong>History</strong> – In the first step, we fit a model to
the data disregarding all information about vector control.</p>
<ul>
<li><p><em>Exposure</em> - one useful intermediate point is to fit a
model of the EIR.</p></li>
<li><p><em>Transmission</em> - alternatively fit a model forced by
mosquito emergence, with adult mosquito ecology and a fully-defined
model of the transmission dynamics. Since vector control modifies adult
mosquito <code>bionomics</code>, the function that we fit is a kind of
<em>naive history</em></p></li>
</ul>
</li>
<li>
<p><strong>Baseline</strong> – We consider malaria epidemiology and
transmission dynamics as a <em>changing baseline</em> that has been
<em>modified by control,</em> so we need to <strong>Imputing a
Baseline</strong> and then <strong>Evaluate Vector Control.</strong> The
problem here is that we have two things to estimate from one time
series. The estimate of the effect size is contingent on the imputed
value of the baseline. Unless we can become omniscient, there’s no way
around this conundrum.</p>
<ul>
<li><p>In years where we think baseline has been modified by vector
control, we need to impute the value of a counterfactual baseline – what
would have happened in the absence of vector control.</p></li>
<li><p>After setting the counterfactual baseline, we fit the
<em>coverage</em> parameter for a model for vector control. From this,
we can compute an effect size of for each event, contingent on the
imputed baseline.</p></li>
</ul>
</li>
</ul>
<p>Once we have done this, we have a model that is ready for
<strong>scenario planning.</strong></p>
<hr>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<div class="section level3">
<h3 id="set-up">Set Up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h3>
<div class="section level4">
<h4 id="build">Build<a class="anchor" aria-label="anchor" href="#build"></a>
</h4>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sis_si</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dd-harp.github.io/ramp.xds/reference/xds_setup.html">xds_setup</a></span><span class="op">(</span>MYZname <span class="op">=</span> <span class="st">"SI"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sis_si</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/xde_scaling_lambda.html">xde_scaling_lambda</a></span><span class="op">(</span><span class="va">sis_si</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dd-harp.github.io/ramp.uganda/" class="external-link">ramp.uganda</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ramp.uganda/man/get_district_pfpr_i.html" class="external-link">get_district_pfpr_i</a></span><span class="op">(</span><span class="fl">124</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">prts</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="set-up-fitting">Set Up Fitting<a class="anchor" aria-label="anchor" href="#set-up-fitting"></a>
</h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sis_si</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup_fitting.html">setup_fitting</a></span><span class="op">(</span><span class="va">sis_si</span>, <span class="va">prts</span><span class="op">$</span><span class="va">pfpr</span>, <span class="va">prts</span><span class="op">$</span><span class="va">jdate</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/show_trend.html">show_trend</a></span><span class="op">(</span><span class="va">sis_si</span><span class="op">)</span></span></code></pre></div>
<p><img src="Fitting_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="baseline">Baseline<a class="anchor" aria-label="anchor" href="#baseline"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="implementation-notes">Implementation Notes<a class="anchor" aria-label="anchor" href="#implementation-notes"></a>
</h2>
<p>The following section is for anyone who is interested in the nuts and
bolts. We hope it helps you track down errors, and maybe you’ll want to
get your hands dirty with <code>ramp.xds</code> or
<code>ramp.work</code> development.</p>
<div class="section level3">
<h3 id="the-model-fitting-object">The Model Fitting Object<a class="anchor" aria-label="anchor" href="#the-model-fitting-object"></a>
</h3>
<p>To handle all the tasks seamlessly, we call
<code>setup_fitting</code> to create a <strong>model fitting</strong>
object, attached to the <strong><code>ramp.xds</code></strong> model
object, <code>model</code> as <code>model$fitting.</code> We use spline
functions to handle the interannual variability. The spline is
configured by passing a set of interpolation points <span class="math inline">\(t, y\)</span> (or <code>ty</code>) The full set of
interpolation points includes three sets: one for the burn-in period;
one for the observational period; and one for forecasting.</p>
<p>To make all of this work generically, we store the object in a
generic format to use for model fitting. The data from
<code>model$fitting</code> are used to recompute a forcing function in
any context.</p>
<p>Model fitting is set up by attaching various compound lists to the
<strong><code>ramp.xds</code></strong> object:</p>
<ul>
<li><p><code>forced_by</code> :: a string to dispatch functions called
during fitting gets stored (options: <code>Lambda</code>,
<code>eir</code>)</p></li>
<li>
<p><code>data$</code> :: interpolation points for the observation
period</p>
<ul>
<li><p><code>tt</code> :: the set of <span class="math inline">\(t\)</span> values for interpolation during the
observational period</p></li>
<li><p><code>yy</code> :: the set of <span class="math inline">\(y\)</span> values for interpolation during the
observational period</p></li>
</ul>
</li>
<li>
<p><code>hindcast$</code></p>
<ul>
<li><p><code>tt</code> :: the set of <span class="math inline">\(t\)</span> values for burning, set by
hindcasting</p></li>
<li><p><code>yy</code> :: the set of <span class="math inline">\(y\)</span> values for burning, set by
hindcasting</p></li>
</ul>
</li>
<li>
<p><code>forecast$</code></p>
<ul>
<li><p><code>tt</code> :: the set of <span class="math inline">\(t\)</span> values for a forecast</p></li>
<li><p><code>yy</code> :: the set of <span class="math inline">\(y\)</span> values for a forecast</p></li>
</ul>
</li>
<li>
<p><code>fitting$</code></p>
<ul>
<li><p><code>tt</code> :: the full set of <span class="math inline">\(t\)</span> values</p></li>
<li><p><code>yy</code> :: the full set of <span class="math inline">\(y\)</span> values</p></li>
</ul>
</li>
</ul>
<p>This gangly object makes it possible to write other functions that
handle all the cases generically.</p>
</div>
<div class="section level3">
<h3 id="defaults-and-options">Defaults and Options<a class="anchor" aria-label="anchor" href="#defaults-and-options"></a>
</h3>
<div class="section level4">
<h4 id="goodness-of-fit-option">Goodness of Fit (Option)<a class="anchor" aria-label="anchor" href="#goodness-of-fit-option"></a>
</h4>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David L. Smith.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
