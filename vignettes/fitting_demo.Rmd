---
title: "Model Fitting"
subtitle: "A Demo"
output: html_document
---

```{r}
library(ramp.xds)
library(ramp.library)
library(ramp.control)
library(ramp.work)
```

In developing malaria models for malaria analysts, we need to be able to deal with malaria data. 

For most of what we want to do, we need The most with time series describing the prevalence of infection with *Plasmodium falciparum,* also called *P. falciparum* parasite rates (*Pf*PR). We would like to use mathematical models to develop a quantitative understanding of malaria epidemiology, mosquito ecology and malaria transmission, and malaria control. On the one hand, we can think of malaria epidemiology as a system *forced by* exposure. On the other hand, we can think of malaria epidemiology and exposure as a system forced by mosquito ecology. 

A set of algorithms was thus developed in **`ramp.work`** to fit models to data in several ways. The two we will focus on here: 

+ Using `xds_setup_eir,` we build a model for the daily EIR, $E(t).$ We do a dynamical time series analysis to reconstruct the history of the putative daily EIR in populations under the assumptions of that model family; 

+ Using `xds_setup` with the trivial `Lmodel,` we build a model for daily emergence rate of adult mosquitoes, $\Lambda(t)$. We do a dynamical time series analysis to reconstruct the history of the putative daily mosquito density populations under the assumptions of that model family. 

In doing this, we will deconsruct a time series patterns into: 

+ mean forcing, the average daily EIR or daily emergence rate over the period; 

+ a seasonal pattern

    - a phase
    
    - amplitude

+ a trend


## Build a Model

To build a model, we use **`ramp.xds`** and **`ramp.library`** 

```{r}
library(ramp.xds)
library(ramp.library)
```

To get started, we build models for the `SIP` model for human exposure. In fact, we build two: one forced by the EIR and the other one forced by emergence:

```{r build a model}
sipsi_eir <- xds_setup_eir(Xname = "SIP")
sipsi_emergence <- xds_setup(Xname = "SIP", MYZname = "SI")
```

Next, we run an algorithm that computes the steady state scaling relationships for the model family at the steady state. The function takes a mesh over mean forcing, and it computes the average annual value of various metrics, including the *Pf*PR.  At this point, we have not configured a seasonal pattern, so the average will be slightly wrong, but it will be *close* enough to ensure that the fitting algorithms work converge to sensible values. 

```{r set up emerge scaling, eval=F}
sipsi_emerge <- xde_scaling_lambda(sipsi_emerge)
sipsi_emerge_base <- sipsi_emerge
```

```{r, echo=F, eval=F}
saveRDS(sipsi_emerge_base, "sipsi_emerge_base.rds")
```

```{r, echo=F}
sipsi_emerge_base <- readRDS("sipsi_emerge_base.rds")
sipsi_emerge <- sipsi_emerge_base 
```


```{r set up eir scaling, eval=F}
sipsi_eir <- xde_scaling_eir(sipsi_eir)
sipsi_eir_base <- sipsi_eir
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_base, "sipsi_eir_base.rds")
```


```{r, echo=F}
sipsi_eir_base <- readRDS("sipsi_eir_base.rds")
sipsi_eir <- sipsi_eir_base 
```

The scaling relationships *could* be rerun after fitting the seasonal pattern, if that's our goal. 

## Set up Fitting 

Next, we want a *Pf*PR time series to analyze. 

```{r ramp.uganda}
library(ramp.uganda)
```

```{r get a PR time series}
prts <- get_district_pfpr_i(132)
prts$district_name[1]
```


```{r setup fitting}
sipsi_eir_terego <- setup_fitting(sipsi_eir, prts$pfpr, prts$jdate)
sipsi_emerge_terego <- setup_fitting(sipsi_emerge, prts$pfpr, prts$jdate)
```

```{r}
show_fit(sipsi_emerge_terego)
show_fit(sipsi_eir_terego, add=TRUE)
```


## Fit Phase 

```{r fit phase, eval=F}
sipsi_eir_terego1 <- fit_season_phase(sipsi_eir_terego)
sipsi_eir_terego1a <- fit_model(sipsi_eir_terego, update="phase", 1)
sipsi_emerge_terego1 <- fit_season_phase(sipsi_emerge_terego)
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego1, "sipsi_eir_terego1.rds")
saveRDS(sipsi_emerge_terego1, "sipsi_emerge_terego1.rds")
```

```{r, echo=F}
sipsi_eir_terego1 <- readRDS("sipsi_eir_terego1.rds")
sipsi_emerge_terego1 <- readRDS("sipsi_emerge_terego1.rds")
```

```{r}
show_fit(sipsi_eir_terego1)  
show_fit(sipsi_emerge_terego1, add=T, clr = "blue") 
```


## Fit Mean Forcing 

```{r fit mean forcing, eval=F}
sipsi_eir_terego2 <- fit_mean_forcing(sipsi_eir_terego1)
sipsi_emerge_terego2 <- fit_mean_forcing(sipsi_emerge_terego1)
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego2, "sipsi_eir_terego2.rds")
saveRDS(sipsi_emerge_terego2, "sipsi_emerge_terego2.rds")
```

```{r, echo=F}
sipsi_eir_terego2 <- readRDS("sipsi_eir_terego2.rds")
sipsi_emerge_terego2 <- readRDS("sipsi_emerge_terego2.rds")
```

```{r}
show_fit(sipsi_eir_terego2)
show_fit(sipsi_emerge_terego2, add=T, clr="blue")
```

## Fit Trend 


```{r fit trend, eval=F}
sipsi_eir_terego3 <- fit_trend(sipsi_eir_terego2)
sipsi_emerge_terego3 <- fit_trend(sipsi_emerge_terego2)
```


```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego3, "sipsi_eir_terego3.rds")
saveRDS(sipsi_emerge_terego3, "sipsi_emerge_terego3.rds")
```

```{r, echo=F}
sipsi_eir_terego3 <- readRDS("sipsi_eir_terego3.rds")
sipsi_emerge_terego3 <- readRDS("sipsi_emerge_terego3.rds")
```

```{r}
show_fit(sipsi_eir_terego3)
show_fit(sipsi_emerge_terego3, add=T, clr="blue")
```

## Fit Amplitude 

```{r fit amplitude, eval=F}
sipsi_eir_terego4 <- fit_season_amplitude(sipsi_eir_terego3)
sipsi_emerge_terego4 <- fit_season_amplitude(sipsi_emerge_terego3)
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego4, "sipsi_eir_terego4.rds")
saveRDS(sipsi_emerge_terego4, "sipsi_emerge_terego4.rds")
```

```{r, echo=F}
sipsi_eir_terego4 <- readRDS("sipsi_eir_terego4.rds")
sipsi_emerge_terego4 <- readRDS("sipsi_emerge_terego4.rds")
```

```{r}
show_fit(sipsi_eir_terego4)
show_fit(sipsi_emerge_terego4, add=T, clr="blue")
```

## Refit Trend 

```{r refit trend, eval=F}
sipsi_eir_terego5 <- fit_trend(sipsi_eir_terego4, c())
sipsi_emerge_terego5 <- fit_trend(sipsi_emerge_terego4, c())
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego5, "sipsi_eir_terego5.rds")
saveRDS(sipsi_emerge_terego5, "sipsi_emerge_terego5.rds")
```

```{r, echo=F}
sipsi_eir_terego5 <- readRDS("sipsi_eir_terego5.rds")
sipsi_emerge_terego5 <- readRDS("sipsi_emerge_terego5.rds")
```

```{r}
show_fit(sipsi_eir_terego5)
show_fit(sipsi_emerge_terego5, add=T, clr="blue")
```


## Fit Season 


```{r fit season, eval=F}
sipsi_eir_terego6 <- fit_season(sipsi_eir_terego5)
sipsi_emerge_terego6 <- fit_season(sipsi_emerge_terego5)
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego6, "sipsi_eir_terego6.rds")
saveRDS(sipsi_emerge_terego6, "sipsi_emerge_terego6.rds")
```

```{r, echo=F}
sipsi_eir_terego6 <- readRDS("sipsi_eir_terego6.rds")
sipsi_emerge_terego6 <- readRDS("sipsi_emerge_terego6.rds")
```

```{r}
show_fit(sipsi_eir_terego6)
show_fit(sipsi_emerge_terego6, add=T, clr="blue")
```

## Fit Model

```{r, eval=F}
ix = list()
ix[[1]] = 1 
ix[[2]] = list()  
sipsi_eir_terego7 = fit_model(sipsi_eir_terego6, update = c("season", "trend"), ix = ix) 
sipsi_emerge_terego7 = fit_model(sipsi_emerge_terego6, update = c("season", "trend"), ix = ix) 
```

```{r, echo=F, eval=F}
saveRDS(sipsi_eir_terego7, "sipsi_eir_terego7.rds")
saveRDS(sipsi_emerge_terego7, "sipsi_emerge_terego7.rds")
```

```{r, echo=F}
sipsi_eir_terego7 <- readRDS("sipsi_eir_terego7.rds")
sipsi_emerge_terego7 <- readRDS("sipsi_emerge_terego7.rds")
```

```{r}
show_fit(sipsi_eir_terego7)
show_fit(sipsi_emerge_terego7, add=T, clr="blue")
```



