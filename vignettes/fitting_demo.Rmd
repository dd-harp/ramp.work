---
title: "Model Fitting"
subtitle: "A Demo"
output: html_document
---

```{r}
library(ramp.xds)
library(ramp.work)
devtools::load_all("~/git/ramp.xds")
devtools::load_all()
```

In developing malaria models for malaria analysts, we need to be able to deal with malaria data. 

For most of what we want to do, we need The most with time series describing the prevalence of infection with *Plasmodium falciparum,* also called *P. falciparum* parasite rates (*Pf*PR). We would like to use mathematical models to develop a quantitative understanding of malaria epidemiology, mosquito ecology and malaria transmission, and malaria control. On the one hand, we can think of malaria epidemiology as a system *forced by* exposure. On the other hand, we can think of malaria epidemiology and exposure as a system forced by mosquito ecology. 

A set of algorithms was thus developed in **`ramp.work`** to fit models to data in several ways. The two we will focus on here: 

+ Using `xds_setup_eir,` we build a model for the daily EIR, $E(t).$ We do a dynamical time series analysis to reconstruct the history of the putative daily EIR in populations under the assumptions of that model family; 

+ Using `xds_setup` with the trivial `Lmodel,` we build a model for daily emergence rate of adult mosquitoes, $\Lambda(t)$. We do a dynamical time series analysis to reconstruct the history of the putative daily mosquito density populations under the assumptions of that model family. 

In doing this, we will deconsruct a time series patterns into: 

+ mean forcing, the average daily EIR or daily emergence rate over the period; 

+ a seasonal pattern

    - a phase
    
    - amplitude

+ a trend


## Build a Model

To build a model, we use base models from **`ramp.xds`.**  We build two: one forced by the EIR and the other one forced by emergence:

```{r build a model}
sissi_eir <- xds_setup_eir(Xname = "SIS")
sissi_eir <- xds_scaling(sissi_eir)
```

## Set up Fitting 

Next, we want a *Pf*PR time series to analyze. 

```{r ramp.uganda}
#library(ramp.uganda)
devtools::load_all("~/git/ramp.uganda")
```

```{r get a PR time series}
prts <- get_district_pfpr_i(132)
prts$district_name[1]
```



```{r setup fitting}
sissi_eir_terego <- setup_fitting(sissi_eir, prts$pfpr, prts$jdate)
```

The function `approx_phase` does a crude analysis to estimate the phase. After setup, the model has an arbitrary seasonal pattern with the same phase as the data.

```{r}
approx_phase(get_PR(sissi_eir_terego), prts$jdate)
approx_phase(prts$pfpr, prts$jdate)
```


```{r}
show_fit(sissi_eir_terego)
```

```{r}
show_residuals(sissi_eir_terego)
```

## Fitting Features 

```{r fit_mean_forcing}
sissi_eir_terego1 <- fit_mean_forcing(sissi_eir_terego)
show_fit(sissi_eir_terego1)
```

```{r fit_trend}
sissi_eir_terego2 <- fit_trend(sissi_eir_terego1)
show_fit(sissi_eir_terego2)
```

```{r fit_season}
sissi_eir_terego3 <- fit_season(sissi_eir_terego2)
show_fit(sissi_eir_terego3)
```



## Model Fitting 

```{r pr2history_xm}
sissi_eir_terego4 <- pr2history_xm(sissi_eir_terego3)
show_fit(sissi_eir_terego4)
```

```{r fit_model}
sissi_eir_terego5 = fit_model(sissi_eir_terego3, feature=c("season", "trend")) 
show_fit(sissi_eir_terego5)
```

```{r}
show_residuals(sissi_eir_terego5)
```

## Fit Phase 

```{r fit phase, eval=F}
sissi_eir_terego1 <- fit_season_phase(sissi_eir_terego)
sissi_eir_terego1 <- xds_solve(sissi_eir_terego1, times=prts$jdate) 
saveRDS(sissi_eir_terego1, "sissi_eir_terego1.rds")
```

```{r}
show_fit(sissi_eir_terego1)
```


```{r}
approx_phase(get_PR(sissi_eir_terego1), prts$jdate)
```

```{r fit phase, eval=F}
sissi_eir_terego1a <- fit_model(sissi_eir_terego, update="phase", 1)
sissi_emerge_terego1 <- fit_season_phase(sissi_emerge_terego)
saveRDS(sissi_emerge_terego1, "sissi_emerge_terego1.rds")
```

```{r}
approx_phase(get_PR(sissi_emerge_terego1), prts$jdate)
approx_phase(prts$pfpr, prts$jdate)
```

```{r, echo=F}
sissi_eir_terego1 <- readRDS("sissi_eir_terego1.rds")
sissi_emerge_terego1 <- readRDS("sissi_emerge_terego1.rds")
```

```{r}
show_fit(sissi_eir_terego1)  
show_fit(sissi_emerge_terego1, add=T, clr = "blue") 
```


## Fit Mean Forcing 

```{r fit mean forcing, eval=F}
sissi_eir_terego2 <- fit_mean_forcing(sissi_eir_terego1)
sissi_emerge_terego2 <- fit_mean_forcing(sissi_emerge_terego1)
```

```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego2, "sissi_eir_terego2.rds")
saveRDS(sissi_emerge_terego2, "sissi_emerge_terego2.rds")
```

```{r, echo=F}
sissi_eir_terego2 <- readRDS("sissi_eir_terego2.rds")
sissi_emerge_terego2 <- readRDS("sissi_emerge_terego2.rds")
```

```{r}
show_fit(sissi_eir_terego2)
show_fit(sissi_emerge_terego2, add=T, clr="blue")
```

## Fit Trend 


```{r fit trend, eval=F}
sissi_eir_terego3 <- fit_trend(sissi_eir_terego2)
sissi_emerge_terego3 <- fit_trend(sissi_emerge_terego2)
```


```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego3, "sissi_eir_terego3.rds")
saveRDS(sissi_emerge_terego3, "sissi_emerge_terego3.rds")
```

```{r, echo=F}
sissi_eir_terego3 <- readRDS("sissi_eir_terego3.rds")
sissi_emerge_terego3 <- readRDS("sissi_emerge_terego3.rds")
```

```{r}
show_fit(sissi_eir_terego3)
show_fit(sissi_emerge_terego3, add=T, clr="blue")
```

## Fit Amplitude 

```{r fit amplitude, eval=F}
sissi_eir_terego4 <- fit_season_amplitude(sissi_eir_terego3)
sissi_emerge_terego4 <- fit_season_amplitude(sissi_emerge_terego3)
```

```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego4, "sissi_eir_terego4.rds")
saveRDS(sissi_emerge_terego4, "sissi_emerge_terego4.rds")
```

```{r, echo=F}
sissi_eir_terego4 <- readRDS("sissi_eir_terego4.rds")
sissi_emerge_terego4 <- readRDS("sissi_emerge_terego4.rds")
```

```{r}
show_fit(sissi_eir_terego4)
show_fit(sissi_emerge_terego4, add=T, clr="blue")
```

## Refit Trend 

```{r refit trend, eval=F}
sissi_eir_terego5 <- fit_trend(sissi_eir_terego4, c())
sissi_emerge_terego5 <- fit_trend(sissi_emerge_terego4, c())
```

```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego5, "sissi_eir_terego5.rds")
saveRDS(sissi_emerge_terego5, "sissi_emerge_terego5.rds")
```

```{r, echo=F}
sissi_eir_terego5 <- readRDS("sissi_eir_terego5.rds")
sissi_emerge_terego5 <- readRDS("sissi_emerge_terego5.rds")
```

```{r}
show_fit(sissi_eir_terego5)
show_fit(sissi_emerge_terego5, add=T, clr="blue")
```


## Fit Season 


```{r fit season, eval=F}
sissi_eir_terego6 <- fit_season(sissi_eir_terego5)
sissi_emerge_terego6 <- fit_season(sissi_emerge_terego5)
```

```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego6, "sissi_eir_terego6.rds")
saveRDS(sissi_emerge_terego6, "sissi_emerge_terego6.rds")
```

```{r, echo=F}
sissi_eir_terego6 <- readRDS("sissi_eir_terego6.rds")
sissi_emerge_terego6 <- readRDS("sissi_emerge_terego6.rds")
```

```{r}
show_fit(sissi_eir_terego6)
show_fit(sissi_emerge_terego6, add=T, clr="blue")
```

## Fit Model

```{r, eval=F}
ix = list()
ix[[1]] = 1 
ix[[2]] = list()  
sissi_eir_terego7 = fit_model(sissi_eir_terego6, update = c("season", "trend"), ix = ix) 
sissi_emerge_terego7 = fit_model(sissi_emerge_terego6, update = c("season", "trend"), ix = ix) 
```

```{r, echo=F, eval=F}
saveRDS(sissi_eir_terego7, "sissi_eir_terego7.rds")
saveRDS(sissi_emerge_terego7, "sissi_emerge_terego7.rds")
```

```{r, echo=F}
sissi_eir_terego7 <- readRDS("sissi_eir_terego7.rds")
sissi_emerge_terego7 <- readRDS("sissi_emerge_terego7.rds")
```

```{r}
show_fit(sissi_eir_terego7)
show_fit(sissi_emerge_terego7, add=T, clr="blue")
```



