---
title: "Pipeline"
output: html_document
---

We want to automate the process of model fitting and baseline reconstruction. It is a common enough task to spell it out. 

```{r}
library(ramp.xds)
library(ramp.library)
library(ramp.control)
suppressMessages(library(ramp.work))
#library(ramp.uganda)
```



## Getting Started 

We want to work with a model family, so we set one up. We will want to use the `eirpr` table created by `xde_scaling_lambda`, but we only need to do it once: 

```{r}
# The block sets `eval=F` to avoid having to repeat this step
x0 <- Sys.time()
sip_si <- xds_setup_eir(Xname = "SIP")
sip_si <- xds_scaling(sip_si)
plot_eirpr(sip_si)
Sys.time()-x0 -> t1
```

## Time Series Data 

```{r prts}
i = 132
prts <- get_district_pfpr_i(i)
district_name <- prts$district_name[1]
```


```{r viz}
with(prts, {
  plot(jdate, pfpr, ylim = c(0,0.65), main = "Terego District", xlab = "Julian Date (day 1 is Jan 1, 2015)", ylab = "PR", xlim = range(0, jdate)) 
  lines(jdate, pfpr)
})
```
## Dynamic Time Series Analysis 

The idea is to fit the same basic model. If we wanted to, we could use `readRDS` to read in the model. 

```
sip_si_base <- readRDS(file_name)
```

```{r setup_fitting}
fit_mod <- setup_fitting(sip_si, prts$pfpr, prts$jdate)
```

After setting up, we have a model that looks all right. 

```{r preview}
fit_mod <- xds_solve(fit_mod, times = prts$jdate)
show_fit(fit_mod)
```

```{r}
x0 <- Sys.time()
fit_mod1 <- pr2history_xm(fit_mod) 
show_fit(fit_mod1)
Sys.time()-x0 -> t2
```


```{r, eval=F}
x0 <- Sys.time()
fit_mod1a <- pr2history(fit_mod1) 
show_fit(fit_mod1)
show_fit(fit_mod1a, add=TRUE)
Sys.time()-x0 -> t3
```


```{r}
x0 <- Sys.time()
fit_mod2 <- pr2history(fit_mod) 
show_fit(fit_mod2)
Sys.time()-x0 -> t4
```

```{r}
x0 <- Sys.time()
fit_mod2a <- pr2history_xm(fit_mod2) 
show_fit(fit_mod2)
show_fit(fit_mod2a, add=TRUE)
Sys.time()-x0 -> t5
```

## Saving Models 

```{r, eval=F}
save_to = "../vignettes/"
#save_to = "/Users/smitdave/Nextcloud/testing/"
#save_to = "/Users/smitdave/git/ramp.uganda/models/"
#save_to = "/Users/smitdave/Library/CloudStorage/Box-Box/RAMP/models/" 
```

```{r, eval=F}
save_as <- "sip_si.rds" 
file_name <- paste(save_to, save_as, sep="")
print(file_name)
```

```{r, eval=F}
file_name <- paste(save_to, save_as, sep="")
saveRDS(fit_mod1a, file_name)
```

```{r, eval=F}
sip_si_from_file <- readRDS(file_name)
``` 
